<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>صورتجلسات حرفه‌ای | شرکت برکت</title>

    <!-- فونت‌ها و آیکون‌ها -->
    <link href="https://cdn.fontcdn.ir/Fonts/Vazir/font-face.css" rel="stylesheet" />
    <link href="https://cdn.fontcdn.ir/Fonts/IranSans/font-face.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css" />

    <style>
        :root {
            --primary-purple: #7c3aed;
            --primary-blue: #06b6d4;
            --primary-pink: #ec4899;
            --primary-green: #22c55e;
            --bg-light: #f9fafb;
            --card-bg: #ffffff;
            --text-dark: #111827;
            --text-muted: #6b7280;
            --border-light: #d1d5db;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 6px 16px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --border-radius: 12px;
            --table-header-bg: linear-gradient(135deg, rgba(124, 58, 237, 0.6), rgba(236, 72, 153, 0.6));
            --font-base: 'Vazir', 'IranSans', 'Inter', sans-serif;
        }

        [data-theme="dark"] {
            --bg-light: #1f2937;
            --card-bg: #374151;
            --text-dark: #f3f4f6;
            --text-muted: #9ca3af;
            --border-light: #4b5563;
            --table-header-bg: linear-gradient(135deg, rgba(124, 58, 237, 0.4), rgba(236, 72, 153, 0.4));
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-base);
            background: linear-gradient(145deg, #e0f2fe, #f3f4f6);
            color: var(--text-dark);
            direction: rtl;
            text-align: right;
            line-height: 1.7;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        [data-theme="dark"] body {
            background: linear-gradient(145deg, #1f2937, #374151);
        }

        .header {
            background: linear-gradient(135deg, var(--primary-purple), var(--primary-blue));
            color: white;
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-md);
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            animation: slideInDown 0.6s ease-out;
        }

        @keyframes slideInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: contain;
            user-select: none;
        }

        .header-right h1 {
            font-weight: 700;
            font-size: 24px;
            margin-right: 12px;
            user-select: none;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .language-toggle {
            background: linear-gradient(135deg, var(--primary-purple), var(--primary-pink));
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .language-toggle:hover,
        .language-toggle:focus {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
            outline: none;
        }

        #lang-display {
            font-size: 16px;
            user-select: none;
        }

        #menu-toggle {
            background: transparent;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
        }

        #menu-toggle:hover,
        #menu-toggle:focus {
            color: var(--primary-pink);
            outline: none;
        }

        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--text-dark);
            box-shadow: var(--shadow-sm);
            z-index: 1000;
            padding: 8px 0;
        }

        .bottom-nav ul {
            display: flex;
            justify-content: space-around;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .bottom-nav li {
            flex: 1;
            text-align: center;
        }

        .bottom-nav a {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            text-decoration: none;
            font-size: 12px;
            padding: 8px 4px;
            transition: var(--transition);
            border-radius: 8px;
            margin: 0 2px;
        }

        .bottom-nav a:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.05);
        }

        .bottom-nav a.active {
            background: linear-gradient(135deg, var(--primary-purple), var(--primary-pink));
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .bottom-nav i {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .bottom-nav span {
            font-size: 10px;
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .bottom-nav {
                display: block;
            }

            .main {
                padding-bottom: 60px;
            }
        }

        .main {
            display: flex;
            flex-grow: 1;
            padding: 24px;
            gap: 24px;
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .sidebar {
            width: 260px;
            background: var(--text-dark);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: 24px 0;
            position: sticky;
            top: 24px;
            align-self: flex-start;
            transition: transform 0.3s ease;
        }

        .sidebar nav ul {
            list-style: none;
        }

        .sidebar nav ul li a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 14px 24px;
            border-radius: 10px;
            margin: 8px 12px;
            transition: var(--transition);
            font-size: 16px;
        }

        .sidebar nav ul li a:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(6px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .sidebar nav ul li a.active {
            background: linear-gradient(135deg, var(--primary-purple), var(--primary-pink));
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .sidebar nav ul li a i {
            font-size: 20px;
            margin-left: 12px;
            width: 28px;
        }

        .container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            width: 100%;
            max-width: 1280px;
        }

        .form-container {
            background: var(--card-bg);
            padding: 32px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            max-width: 960px;
            width: 100%;
            transition: var(--transition);
            overflow: visible;
        }

        .form-container:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-4px);
        }

        .form-container h2 {
            text-align: center;
            color: var(--primary-purple);
            margin-bottom: 24px;
            font-size: 32px;
            font-weight: 700;
            position: relative;
            user-select: none;
        }

        .form-container h2::after {
            content: '';
            display: block;
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue), var(--primary-pink));
            margin: 12px auto;
            border-radius: 2px;
        }

        .form-section {
            margin-bottom: 16px;
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            background: var(--card-bg);
            overflow: visible;
            transition: var(--transition);
        }

        .form-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            background: linear-gradient(to right, #f9fafb, #ffffff);
            transition: var(--transition);
            user-select: none;
        }

        [data-theme="dark"] .form-section-header {
            background: linear-gradient(to right, #374151, #4b5563);
        }

        .form-section-header:hover,
        .form-section-header:focus {
            background: linear-gradient(to right, #f3f4f6, #ffffff);
            transform: translateY(-2px);
            outline: none;
        }

        [data-theme="dark"] .form-section-header:hover,
        [data-theme="dark"] .form-section-header:focus {
            background: linear-gradient(to right, #4b5563, #6b7280);
        }

        .form-section-header h3 {
            color: var(--primary-purple);
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-section-header i {
            font-size: 16px;
            color: var(--primary-blue);
            transition: transform 0.3s ease;
        }

        .form-section-header i.rotate-down {
            transform: rotate(90deg);
        }

        .form-section-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease;
        }

        .form-section-content.active {
            padding: 16px 20px;
            max-height: 1200px;
            overflow: visible;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
            margin-bottom: 12px;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-dark);
        }

        .required-star {
            display: none;
            color: #ef4444;
            font-size: 16px;
        }

        .required-star.show {
            display: inline;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid var(--border-light);
            border-radius: 10px;
            font-size: 14px;
            background: var(--card-bg);
            color: var(--text-dark);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-purple);
            box-shadow: 0 0 6px rgba(124, 58, 237, 0.3);
            outline: none;
            transform: scale(1.01);
        }

        .form-group.error input,
        .form-group.error select,
        .form-group.error textarea {
            animation: shake 0.3s ease;
            border-color: #ef4444;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        .time-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .time-row .form-group {
            flex: 1;
            min-width: 0;
        }

        .time-row .form-group input[type="time"] {
            min-width: 150px;
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border-radius: 10px;
            border: 1px solid var(--border-light);
            background: var(--card-bg);
            color: var(--text-dark);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .time-row .form-group input[type="time"]:focus {
            border-color: var(--primary-purple);
            box-shadow: 0 0 6px rgba(124, 58, 237, 0.3);
            outline: none;
            transform: scale(1.01);
        }

        .btn {
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            user-select: none;
            min-width: 100px;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .btn:hover::after {
            width: 300%;
            height: 300%;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-purple), var(--primary-pink));
        }

        .btn-success {
            background: linear-gradient(135deg, var(--primary-green), #16a34a);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--primary-blue), #0284c7);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f43f5e, #b91c1c);
        }

        .btn-whatsapp {
            background: linear-gradient(135deg, #25d366, #16a34a);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            min-width: 70px;
        }

        #calendar-button {
            padding: 6px 10px;
            font-size: 12px;
            min-width: 60px;
            margin-left: 8px;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-start;
            margin-top: 16px;
        }

        .table-responsive {
            overflow-x: auto;
            max-width: 100%;
        }

        .data-table {
            width: 100%;
            min-width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            animation: fadeIn 0.6s ease-out;
        }

        th, td {
            border: 1px solid var(--border-light);
            padding: 10px 12px;
            text-align: right;
            font-size: 14px;
        }

        th:first-child,
        td:first-child,
        th:last-child,
        td:last-child {
            width: 80px;
            text-align: center;
        }

        thead th {
            background: var(--table-header-bg);
            color: white;
            font-weight: 700;
        }

        tbody tr {
            transition: background 0.3s ease;
        }

        tbody tr:nth-child(even) {
            background: var(--card-bg);
        }

        tbody tr:hover {
            background: #e5e7eb;
        }

        [data-theme="dark"] tbody tr:hover {
            background: #4b5563;
        }

        .sr-only {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
        }

        .search-bar {
            width: 100%;
            padding: 10px;
            margin-bottom: 16px;
            border: 1px solid var(--border-light);
            border-radius: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <header class="header" role="banner">
        <div class="header-right" aria-label="لوگو و عنوان سایت">
            <img src="/icon-192.png" alt="لوگو شرکت برکت" class="logo" />
            <h1 data-i18n="sessions">صورتجلسات</h1>
        </div>
        <div class="header-left">
            <button id="language-toggle" class="language-toggle" aria-label="تغییر زبان سایت" aria-pressed="false">
                <span id="lang-display">fa</span>
            </button>
            <button id="menu-toggle" aria-label="بازکردن منو"><i class="fas fa-bars"></i></button>
        </div>
    </header>

    <nav class="bottom-nav" role="navigation" aria-label="ناوبری پایین صفحه">
        <ul>
            <li><a href="#" id="nav-session-mobile" class="active"><i class="fas fa-plus-circle"></i><span data-i18n="new_session">جلسه</span></a></li>
            <li><a href="#" id="nav-contacts-mobile"><i class="fas fa-address-book"></i><span data-i18n="contacts">مخاطبین</span></a></li>
            <li><a href="#" id="nav-archive-mobile"><i class="fas fa-archive"></i><span data-i18n="archive">آرشیو</span></a></li>
            <li><a href="#" id="nav-dashboard-mobile"><i class="fas fa-chart-bar"></i><span data-i18n="dashboard">داشبورد</span></a></li>
            <li><a href="#" id="nav-settings-mobile"><i class="fas fa-cogs"></i><span data-i18n="settings">تنظیمات</span></a></li>
            <li><a href="#" id="nav-logout-mobile"><i class="fas fa-sign-out-alt"></i><span data-i18n="logout">خروج</span></a></li>
        </ul>
    </nav>

    <main class="main" role="main">
        <aside class="sidebar" role="navigation" aria-label="ناوبری اصلی">
            <nav>
                <ul>
                    <li><a href="#" class="active" id="nav-session"><i class="fas fa-plus-circle"></i> <span data-i18n="new_session">جلسه جدید</span></a></li>
                    <li><a href="#" id="nav-contacts"><i class="fas fa-address-book"></i> <span data-i18n="contacts">مخاطبین</span></a></li>
                    <li><a href="#" id="nav-archive"><i class="fas fa-archive"></i> <span data-i18n="archive">آرشیو</span></a></li>
                    <li><a href="#" id="nav-dashboard"><i class="fas fa-chart-bar"></i> <span data-i18n="dashboard">داشبورد</span></a></li>
                    <li><a href="#" id="nav-settings"><i class="fas fa-cogs"></i> <span data-i18n="settings">تنظیمات</span></a></li>
                    <li><a href="#" id="nav-logout"><i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">خروج</span></a></li>
                </ul>
            </nav>
        </aside>

        <section class="container" aria-live="polite">
            <!-- فرم ثبت صورتجلسه -->
            <article class="form-container" id="session-view" aria-label="فرم ثبت صورتجلسه">
                <h2 data-i18n="session_form">فرم ثبت صورتجلسه</h2>

                <section class="form-section" data-toggle="accordion" aria-expanded="true" tabindex="0" id="section-session-info">
                    <header class="form-section-header" role="button" aria-controls="session-info" aria-expanded="true" tabindex="0">
                        <h3><i class="fas fa-info-circle"></i> <span data-i18n="session_info">اطلاعات جلسه</span></h3>
                        <i class="fas fa-chevron-left rotate-down"></i>
                    </header>
                    <div class="form-section-content active" id="session-info">
                        <div class="form-grid">
                            <div class="form-group required">
                                <label for="session-number" data-i18n="session_number">شماره جلسه: <span class="required-star show">*</span></label>
                                <input type="text" id="session-number" data-i18n-placeholder="session_number_placeholder" aria-required="true" />
                            </div>
                            <div class="form-group required">
                                <label for="session-date" data-i18n="session_date">تاریخ: <span class="required-star show">*</span></label>
                                <input type="text" id="session-date" class="pdp" readonly aria-required="true" aria-describedby="session-date-desc" />
                                <small id="session-date-desc" class="sr-only">تاریخ جلسه به صورت شمسی</small>
                            </div>
                            <div class="time-row">
                                <div class="form-group required">
                                    <label for="start-time" data-i18n="start_time">ساعت شروع: <span class="required-star show">*</span></label>
                                    <input type="time" id="start-time" aria-required="true" />
                                </div>
                                <div class="form-group">
                                    <label for="end-time" data-i18n="end_time">ساعت پایان:</label>
                                    <input type="time" id="end-time" />
                                </div>
                            </div>
                            <div class="form-group full-width required">
                                <label for="session-title" data-i18n="session_title">عنوان جلسه: <span class="required-star show">*</span></label>
                                <input type="text" id="session-title" data-i18n-placeholder="session_title_placeholder" aria-required="true" />
                            </div>
                            <div class="form-group required">
                                <label for="location" data-i18n="location">مکان: <span class="required-star show">*</span></label>
                                <select id="location" aria-required="true" aria-describedby="location-manual-desc">
                                    <option value="" data-i18n="select_location">انتخاب مکان</option>
                                    <option value="شعبه لبخند">شعبه لبخند</option>
                                    <option value="شعبه مسجد">شعبه مسجد</option>
                                    <option value="شعبه الزهرا">شعبه الزهرا</option>
                                    <option value="دفتر باغ فیض">دفتر باغ فیض</option>
                                    <option value="دفتر تالار سرای مهر">دفتر تالار سرای مهر</option>
                                    <option value="manual" data-i18n="manual_location">وارد کردن دستی</option>
                                </select>
                                <input type="text" id="location-manual" style="display: none; margin-top: 8px;" data-i18n-placeholder="location_manual" aria-describedby="location-manual-desc" />
                                <small id="location-manual-desc" class="sr-only">اگر گزینه وارد کردن دستی انتخاب شد، این فیلد فعال می‌شود</small>
                            </div>
                            <div class="form-group required">
                                <label for="organizer" data-i18n="organizer">برگزارکننده: <span class="required-star show">*</span></label>
                                <input type="text" id="organizer" data-i18n-placeholder="organizer_placeholder" aria-required="true" />
                            </div>
                            <div class="form-group full-width">
                                <label for="session-files" data-i18n="session_files">فایل‌های مرتبط:</label>
                                <input type="file" id="session-files" multiple accept=".pdf,.docx,.jpg,.png" aria-label="انتخاب فایل‌های مرتبط با جلسه" />
                            </div>
                        </div>
                    </div>
                </section>

                <section class="form-section" data-toggle="accordion" aria-expanded="false" tabindex="0" id="section-attendees">
                    <header class="form-section-header" role="button" aria-controls="attendees-section" aria-expanded="false" tabindex="0">
                        <h3><i class="fas fa-users"></i> <span data-i18n="attendees">شرکت‌کنندگان</span></h3>
                        <i class="fas fa-chevron-right"></i>
                    </header>
                    <div class="form-section-content" id="attendees-section" aria-hidden="true">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="attendee-name" data-i18n="attendee_name">نام:</label>
                                <input type="text" id="attendee-name" data-i18n-placeholder="attendee_name" />
                            </div>
                            <div class="form-group">
                                <label for="attendee-mobile" data-i18n="attendee_mobile">موبایل:</label>
                                <input type="text" id="attendee-mobile" data-i18n-placeholder="attendee_mobile" />
                            </div>
                            <div class="form-group" style="align-self: flex-end;">
                                <button type="button" id="add-attendee" class="btn btn-success btn-sm" aria-label="افزودن شرکت‌کننده">
                                    <i class="fas fa-plus"></i> <span data-i18n="add">افزودن</span>
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive" aria-live="polite" aria-relevant="all">
                            <table class="data-table" id="attendees-table" aria-label="لیست شرکت‌کنندگان">
                                <thead>
                                    <tr>
                                        <th data-i18n="row">ردیف</th>
                                        <th data-i18n="attendee_name">نام</th>
                                        <th data-i18n="attendee_mobile">موبایل</th>
                                        <th data-i18n="action">عمل</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section class="form-section" data-toggle="accordion" aria-expanded="false" tabindex="0" id="section-decisions">
                    <header class="form-section-header" role="button" aria-controls="decisions-section" aria-expanded="false" tabindex="0">
                        <h3><i class="fas fa-check-square"></i> <span data-i18n="decisions">مصوبات</span></h3>
                        <i class="fas fa-chevron-right"></i>
                    </header>
                    <div class="form-section-content" id="decisions-section" aria-hidden="true">
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label for="decision-text" data-i18n="decision_text">مصوبه:</label>
                                <input type="text" id="decision-text" data-i18n-placeholder="decision_text" />
                            </div>
                            <div class="form-group">
                                <label for="decision-responsible" data-i18n="decision_responsible">مسئول:</label>
                                <input type="text" id="decision-responsible" data-i18n-placeholder="decision_responsible" />
                            </div>
                            <div class="form-group">
                                <label for="decision-due-date" data-i18n="decision_due_date">مهلت:</label>
                                <input type="text" id="decision-due-date" class="pdp" readonly />
                            </div>
                            <div class="form-group">
                                <label for="decision-status" data-i18n="decision_status">وضعیت:</label>
                                <select id="decision-status">
                                    <option value="در حال انجام" data-i18n="in_progress">در حال انجام</option>
                                    <option value="تکمیل شده" data-i18n="completed">تکمیل شده</option>
                                    <option value="لغو شده" data-i18n="canceled">لغو شده</option>
                                </select>
                            </div>
                            <div class="form-group" style="align-self: flex-end;">
                                <button type="button" id="add-decision" class="btn btn-success btn-sm" aria-label="افزودن مصوبه">
                                    <i class="fas fa-plus"></i> <span data-i18n="add">افزودن</span>
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive" aria-live="polite" aria-relevant="all">
                            <table class="data-table" id="decisions-table" aria-label="لیست مصوبات">
                                <thead>
                                    <tr>
                                        <th data-i18n="row">ردیف</th>
                                        <th data-i18n="decision_text">مصوبه</th>
                                        <th data-i18n="decision_responsible">مسئول</th>
                                        <th data-i18n="decision_due_date">مهلت</th>
                                        <th data-i18n="decision_status">وضعیت</th>
                                        <th data-i18n="action">عمل</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section class="form-section" data-toggle="accordion" aria-expanded="false" tabindex="0" id="section-notes">
                    <header class="form-section-header" role="button" aria-controls="notes-section" aria-expanded="false" tabindex="0">
                        <h3><i class="fas fa-comment"></i> <span data-i18n="notes">یادداشت‌ها</span></h3>
                        <i class="fas fa-chevron-right"></i>
                    </header>
                    <div class="form-section-content" id="notes-section" aria-hidden="true">
                        <div class="form-group full-width">
                            <label for="notes" data-i18n="notes">یادداشت:</label>
                            <textarea id="notes" rows="5" data-i18n-placeholder="notes_placeholder"></textarea>
                        </div>
                    </div>
                </section>

                <div class="action-buttons">
                    <button type="button" id="save-button" class="btn btn-primary" aria-label="ذخیره صورتجلسه">
                        <i class="fas fa-save"></i> <span data-i18n="save">ذخیره</span>
                    </button>
                    <button type="button" id="print-button" class="btn btn-success" aria-label="دانلود PDF">
                        <i class="fas fa-print"></i> <span data-i18n="pdf">PDF</span>
                    </button>
                    <button type="button" id="export-button" class="btn btn-info" aria-label="دانلود Excel">
                        <i class="fas fa-file-excel"></i> <span data-i18n="excel">Excel</span>
                    </button>
                    <button type="button" id="whatsapp-button" class="btn btn-whatsapp" aria-label="ارسال به واتساپ">
                        <i class="fab fa-whatsapp"></i> <span data-i18n="whatsapp">واتساپ</span>
                    </button>
                    <button type="button" id="calendar-button" class="btn btn-info btn-sm" aria-label="افزودن به تقویم">
                        <i class="fas fa-calendar-plus"></i> <span data-i18n="add_to_calendar">تقویم</span>
                    </button>
                    <button type="button" id="share-button" class="btn btn-primary btn-sm" aria-label="اشتراک‌گذاری جلسه">
                        <i class="fas fa-share-alt"></i> <span data-i18n="share_session">اشتراک</span>
                    </button>
                </div>
            </article>

            <!-- بخش مخاطبین -->
            <article class="form-container" id="contacts-view" style="display: none;" aria-label="مدیریت مخاطبین">
                <h2><i class="fas fa-address-book"></i> <span data-i18n="contacts">مدیریت مخاطبین</span></h2>
                <section class="form-section" data-toggle="accordion" aria-expanded="true" tabindex="0" id="section-add-contact">
                    <header class="form-section-header" role="button" aria-controls="add-contact-section" aria-expanded="true" tabindex="0">
                        <h3 data-i18n="add_contact">افزودن مخاطب</h3>
                        <i class="fas fa-chevron-left rotate-down"></i>
                    </header>
                    <div class="form-section-content active" id="add-contact-section">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="contact-name" data-i18n="attendee_name">نام:</label>
                                <input type="text" id="contact-name" data-i18n-placeholder="attendee_name" />
                            </div>
                            <div class="form-group">
                                <label for="contact-mobile" data-i18n="attendee_mobile">موبایل:</label>
                                <input type="text" id="contact-mobile" data-i18n-placeholder="attendee_mobile" />
                            </div>
                            <div class="form-group" style="align-self: flex-end;">
                                <button type="button" id="add-contact" class="btn btn-success btn-sm" aria-label="افزودن مخاطب">
                                    <i class="fas fa-plus"></i> <span data-i18n="add">افزودن</span>
                                </button>
                                <button type="button" id="import-contacts" class="btn btn-info btn-sm" aria-label="وارد کردن مخاطبین">
                                    <i class="fas fa-upload"></i> <span data-i18n="import_contacts">وارد کردن</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="form-section" data-toggle="accordion" aria-expanded="false" tabindex="0" id="section-contacts-list">
                    <header class="form-section-header" role="button" aria-controls="contacts-list-section" aria-expanded="false" tabindex="0">
                        <h3 data-i18n="contacts_list">لیست مخاطبین</h3>
                        <i class="fas fa-chevron-right"></i>
                    </header>
                    <div class="form-section-content" id="contacts-list-section" aria-hidden="true">
                        <input type="text" id="contacts-search" class="search-bar" data-i18n-placeholder="search_contacts" aria-label="جستجو در مخاطبین" />
                        <div class="table-responsive" aria-live="polite" aria-relevant="all">
                            <table class="data-table" id="contacts-table" aria-label="لیست مخاطبین">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="select-all-contacts" aria-label="انتخاب همه مخاطبین" /></th>
                                        <th data-i18n="row">ردیف</th>
                                        <th data-i18n="attendee_name">نام</th>
                                        <th data-i18n="attendee_mobile">موبایل</th>
                                        <th data-i18n="action">عمل</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <button type="button" id="add-selected-attendees" class="btn btn-success btn-sm" style="margin-top:12px;" data-i18n="add_selected_attendees">
                            افزودن شرکت‌کنندگان انتخاب شده
                        </button>
                    </div>
                </section>
            </article>

            <!-- بخش آرشیو -->
            <article class="form-container" id="archive-view" style="display: none;" aria-label="آرشیو جلسات">
                <h2><i class="fas fa-archive"></i> <span data-i18n="archive">آرشیو جلسات</span></h2>
                <input type="text" id="archive-search" class="search-bar" data-i18n-placeholder="search_archive" aria-label="جستجو در آرشیو جلسات" />
                <div class="table-responsive" aria-live="polite" aria-relevant="all">
                    <table class="data-table" id="archive-table" aria-label="لیست آرشیو جلسات">
                        <thead>
                            <tr>
                                <th data-i18n="row">ردیف</th>
                                <th data-i18n="session_number">شماره جلسه</th>
                                <th data-i18n="session_title">عنوان</th>
                                <th data-i18n="session_date">تاریخ</th>
                                <th data-i18n="action">عمل</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </article>

            <!-- بخش داشبورد -->
            <article class="form-container" id="dashboard-view" style="display: none;" aria-label="داشبورد">
                <h2><i class="fas fa-chart-bar"></i> <span data-i18n="dashboard">داشبورد</span></h2>
                <section class="form-section" data-toggle="accordion" aria-expanded="true" tabindex="0" id="section-dashboard">
                    <header class="form-section-header" role="button" aria-controls="dashboard-content" aria-expanded="true" tabindex="0">
                        <h3 data-i18n="session_stats">آمار جلسات</h3>
                        <i class="fas fa-chevron-left rotate-down"></i>
                    </header>
                    <div class="form-section-content active" id="dashboard-content">
                        <p data-i18n="stats_coming_soon">آمار جلسات و مصوبات به زودی اضافه خواهد شد.</p>
                    </div>
                </section>
            </article>

            <!-- بخش تنظیمات -->
            <article class="form-container" id="settings-view" style="display: none;" aria-label="تنظیمات">
                <h2><i class="fas fa-cogs"></i> <span data-i18n="settings">تنظیمات</span></h2>
                <section class="form-section" data-toggle="accordion" aria-expanded="true" tabindex="0" id="section-settings">
                    <header class="form-section-header" role="button" aria-controls="settings-content" aria-expanded="true" tabindex="0">
                        <h3 data-i18n="general_settings">تنظیمات عمومی</h3>
                        <i class="fas fa-chevron-left rotate-down"></i>
                    </header>
                    <div class="form-section-content active" id="settings-content">
                        <div class="form-group">
                            <label for="theme" data-i18n="theme">انتخاب تم:</label>
                            <select id="theme">
                                <option value="light" data-i18n="light_theme">روشن</option>
                                <option value="dark" data-i18n="dark_theme">تیره</option>
                            </select>
                        </div>
                    </div>
                </section>
            </article>
        </section>
    </main>

    <!-- مودال خلاصه واتساپ -->
    <div id="whatsapp-summary-modal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.3); max-width:400px; z-index:2000;">
        <h3 data-i18n="whatsapp_summary">خلاصه جلسه برای واتساپ</h3>
        <textarea id="whatsapp-summary-text" rows="10" style="width:100%; margin-bottom:10px;"></textarea>
        <button id="send-whatsapp" class="btn btn-whatsapp btn-sm" style="margin-bottom:10px;" data-i18n="send_whatsapp">ارسال</button>
        <button id="download-pdf-btn" class="btn btn-success btn-sm" style="margin-bottom:10px;" data-i18n="pdf">دانلود PDF</button>
        <button id="close-whatsapp-modal" class="btn btn-danger btn-sm" data-i18n="close">بستن</button>
    </div>

    <!-- اسکریپت‌ها -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.15.1/dist/umd/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js"></script>

    <script>
    $(function() {
        // --- 1. i18next راه‌اندازی ---
        i18next.init({
            lng: 'fa',
            debug: false,
            resources: {
                fa: {
                    translation: {
                        sessions: "صورتجلسات",
                        new_session: "جلسه جدید",
                        contacts: "مخاطبین",
                        archive: "آرشیو",
                        dashboard: "داشبورد",
                        settings: "تنظیمات",
                        logout: "خروج",
                        session_form: "فرم ثبت صورتجلسه",
                        session_info: "اطلاعات جلسه",
                        attendees: "شرکت‌کنندگان",
                        decisions: "مصوبات",
                        notes: "یادداشت‌ها",
                        save: "ذخیره",
                        pdf: "PDF",
                        excel: "Excel",
                        whatsapp: "واتساپ",
                        add_to_calendar: "افزودن به تقویم",
                        share_session: "اشتراک‌گذاری",
                        session_number: "شماره جلسه",
                        session_date: "تاریخ",
                        start_time: "ساعت شروع",
                        end_time: "ساعت پایان",
                        session_title: "عنوان جلسه",
                        location: "مکان",
                        organizer: "برگزارکننده",
                        session_files: "فایل‌های مرتبط",
                        attendee_name: "نام",
                        attendee_mobile: "موبایل",
                        decision_text: "مصوبه",
                        decision_responsible: "مسئول",
                        decision_due_date: "مهلت",
                        decision_status: "وضعیت",
                        notes_placeholder: "یادداشت‌ها...",
                        session_number_placeholder: "مثال: ۰۱",
                        session_title_placeholder: "عنوان",
                        organizer_placeholder: "نام",
                        location_manual: "مکان را وارد کنید",
                        select_location: "انتخاب مکان",
                        manual_location: "وارد کردن دستی",
                        in_progress: "در حال انجام",
                        completed: "تکمیل شده",
                        canceled: "لغو شده",
                        add: "افزودن",
                        import_contacts: "وارد کردن",
                        add_contact: "افزودن مخاطب",
                        contacts_list: "لیست مخاطبین",
                        search_contacts: "جستجو در مخاطبین",
                        search_archive: "جستجو در جلسات",
                        add_selected_attendees: "افزودن شرکت‌کنندگان انتخاب شده",
                        row: "ردیف",
                        action: "عمل",
                        session_stats: "آمار جلسات",
                        stats_coming_soon: "آمار جلسات و مصوبات به زودی اضافه خواهد شد",
                        general_settings: "تنظیمات عمومی",
                        theme: "انتخاب تم",
                        light_theme: "روشن",
                        dark_theme: "تیره",
                        whatsapp_summary: "خلاصه جلسه برای واتساپ",
                        send_whatsapp: "ارسال",
                        close: "بستن",
                        fill_required_fields: "لطفاً فیلدهای اجباری را پر کنید",
                        add_attendee_or_decision: "لطفاً حداقل یک شرکت‌کننده یا مصوبه اضافه کنید",
                        session_saved: "جلسه با موفقیت ذخیره شد",
                        contacts_permission: "لطفاً دسترسی به مخاطبین را فعال کنید",
                        contacts_error: "خطا در دسترسی به مخاطبین",
                        hello: "سلام",
                        thanks: "با تشکر",
                        company_barakat: "شرکت برکت",
                        calendar_added: "جلسه به تقویم اضافه شد",
                        share_error: "اشتراک‌گذاری در این مرورگر پشتیبانی نمی‌شود"
                    }
                },
                en: {
                    translation: {
                        sessions: "Sessions",
                        new_session: "New Session",
                        contacts: "Contacts",
                        archive: "Archive",
                        dashboard: "Dashboard",
                        settings: "Settings",
                        logout: "Logout",
                        session_form: "Session Form",
                        session_info: "Session Info",
                        attendees: "Attendees",
                        decisions: "Decisions",
                        notes: "Notes",
                        save: "Save",
                        pdf: "PDF",
                        excel: "Excel",
                        whatsapp: "WhatsApp",
                        add_to_calendar: "Add to Calendar",
                        share_session: "Share Session",
                        session_number: "Session Number",
                        session_date: "Date",
                        start_time: "Start Time",
                        end_time: "End Time",
                        session_title: "Session Title",
                        location: "Location",
                        organizer: "Organizer",
                        session_files: "Related Files",
                        attendee_name: "Name",
                        attendee_mobile: "Mobile",
                        decision_text: "Decision",
                        decision_responsible: "Responsible",
                        decision_due_date: "Due Date",
                        decision_status: "Status",
                        notes_placeholder: "Notes...",
                        session_number_placeholder: "Example: 01",
                        session_title_placeholder: "Title",
                        organizer_placeholder: "Name",
                        location_manual: "Enter location",
                        select_location: "Select location",
                        manual_location: "Manual entry",
                        in_progress: "In Progress",
                        completed: "Completed",
                        canceled: "Canceled",
                        add: "Add",
                        import_contacts: "Import",
                        add_contact: "Add Contact",
                        contacts_list: "Contacts List",
                        search_contacts: "Search Contacts",
                        search_archive: "Search Sessions",
                        add_selected_attendees: "Add Selected Attendees",
                        row: "Row",
                        action: "Action",
                        session_stats: "Session Statistics",
                        stats_coming_soon: "Session and decision statistics will be added soon",
                        general_settings: "General Settings",
                        theme: "Select Theme",
                        light_theme: "Light",
                        dark_theme: "Dark",
                        whatsapp_summary: "Session Summary for WhatsApp",
                        send_whatsapp: "Send",
                        close: "Close",
                        fill_required_fields: "Please fill in the required fields",
                        add_attendee_or_decision: "Please add at least one attendee or decision",
                        session_saved: "Session saved successfully",
                        contacts_permission: "Please enable contacts access",
                        contacts_error: "Error accessing contacts",
                        hello: "Hello",
                        thanks: "Thank you",
                        company_barakat: "Barakat Company",
                        calendar_added: "Session added to calendar",
                        share_error: "Sharing is not supported in this browser"
                    }
                }
            }
        }, function(err, t) {
            updateContent();
        });

        function updateContent() {
            $('[data-i18n]').each(function() {
                const key = $(this).attr('data-i18n');
                $(this).text(i18next.t(key));
            });
            $('[data-i18n-placeholder]').each(function() {
                const key = $(this).attr('data-i18n-placeholder');
                $(this).attr('placeholder', i18next.t(key));
            });
            $('#contacts-search').attr('placeholder', i18next.t('search_contacts') + '...');
            $('#archive-search').attr('placeholder', i18next.t('search_archive') + '...');
            $('#decision-status option').each(function() {
                const key = $(this).attr('data-i18n');
                $(this).text(i18next.t(key));
            });
        }

        $('#language-toggle').on('click', function() {
            const newLang = i18next.language === 'fa' ? 'en' : 'fa';
            i18next.changeLanguage(newLang, () => {
                updateContent();
                $('#lang-display').text(newLang);
                $('body').attr('dir', newLang === 'fa' ? 'rtl' : 'ltr');
                $('body').css('text-align', newLang === 'fa' ? 'right' : 'left');
            });
        });

        // --- 2. Persian Datepicker راه‌اندازی ---
        $('.pdp').persianDatepicker({
            format: 'YYYY/MM/DD',
            autoClose: true,
            initialValueType: 'persian',
            calendarType: 'persian',
            timeZone: 'Asia/Tehran',
            onSelect: function(unix) {
                const date = new persianDate(unix).toLocale('fa').format('YYYY/MM/DD');
                $(this).val(date);
                console.log('Selected Persian Date:', date);
            }
        });

        // --- 3. آکاردئون ---
        $('.form-section-header').on('click keypress', function(e) {
            if (e.type === "click" || e.key === "Enter" || e.key === " ") {
                const header = $(this);
                const content = header.next('.form-section-content');
                const icon = header.find('i').first();

                $('.form-section-content').not(content).removeClass('active').attr('aria-hidden', 'true');
                $('.form-section-header').not(header).attr('aria-expanded', 'false');
                $('.form-section-header i').not(icon).removeClass('rotate-down fa-chevron-left').addClass('fa-chevron-right');

                if (content.hasClass('active')) {
                    content.removeClass('active').attr('aria-hidden', 'true');
                    header.attr('aria-expanded', 'false');
                    icon.removeClass('rotate-down fa-chevron-left').addClass('fa-chevron-right');
                } else {
                    content.addClass('active').attr('aria-hidden', 'false');
                    header.attr('aria-expanded', 'true');
                    icon.addClass('rotate-down fa-chevron-left').removeClass('fa-chevron-right');
                }
            }
        });

        // --- 4. ناوبری بین بخش‌ها ---
        function showView(viewId) {
            $('.form-container').hide();
            $(`#${viewId}`).show();
        }

        $('#nav-session, #nav-session-mobile').on('click', e => {
            e.preventDefault();
            showView('session-view');
            $('.sidebar nav a, .bottom-nav a').removeClass('active');
            $('#nav-session, #nav-session-mobile').addClass('active');
        });

        $('#nav-contacts, #nav-contacts-mobile').on('click', e => {
            e.preventDefault();
            showView('contacts-view');
            $('.sidebar nav a, .bottom-nav a').removeClass('active');
            $('#nav-contacts, #nav-contacts-mobile').addClass('active');
        });

        $('#nav-archive, #nav-archive-mobile').on('click', e => {
            e.preventDefault();
            showView('archive-view');
            $('.sidebar nav a, .bottom-nav a').removeClass('active');
            $('#nav-archive, #nav-archive-mobile').addClass('active');
            renderArchive();
        });

        $('#nav-dashboard, #nav-dashboard-mobile').on('click', e => {
            e.preventDefault();
            showView('dashboard-view');
            $('.sidebar nav a, .bottom-nav a').removeClass('active');
            $('#nav-dashboard, #nav-dashboard-mobile').addClass('active');
        });

        $('#nav-settings, #nav-settings-mobile').on('click', e => {
            e.preventDefault();
            showView('settings-view');
            $('.sidebar nav a, .bottom-nav a').removeClass('active');
            $('#nav-settings, #nav-settings-mobile').addClass('active');
        });

        $('#nav-logout, #nav-logout-mobile').on('click', e => {
            e.preventDefault();
            localStorage.removeItem('sessions');
            localStorage.removeItem('contacts');
            Toastify({
                text: i18next.t('logout') + " با موفقیت انجام شد.",
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#22c55e"
            }).showToast();
            window.location.href = '/login';
        });

        // --- 5. انتخاب مکان دستی ---
        $('#location').on('change', function() {
            if ($(this).val() === 'manual') {
                $('#location-manual').show().focus();
            } else {
                $('#location-manual').hide();
            }
        });

        // --- 6. افزودن شرکت‌کننده ---
        let attendees = [];

        function renderAttendees() {
            const tbody = $('#attendees-table tbody');
            tbody.empty();
            attendees.forEach((a, i) => {
                tbody.append(`
                    <tr>
                        <td>${i + 1}</td>
                        <td>${a.name}</td>
                        <td>${a.mobile}</td>
                        <td><button class="btn btn-danger btn-sm delete-attendee" data-index="${i}" aria-label="حذف شرکت‌کننده"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `);
            });
        }

        $('#add-attendee').on('click', () => {
            const name = $('#attendee-name').val().trim();
            const mobile = $('#attendee-mobile').val().trim();
            if (name && mobile) {
                attendees.push({ name, mobile });
                renderAttendees();
                $('#attendee-name, #attendee-mobile').val('');
            } else {
                Toastify({
                    text: i18next.t('attendee_name') + " و " + i18next.t('attendee_mobile') + " را وارد کنید.",
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#ef4444"
                }).showToast();
            }
        });

        $('#attendees-table').on('click', '.delete-attendee', function() {
            const idx = $(this).data('index');
            attendees.splice(idx, 1);
            renderAttendees();
        });

        // --- 7. مدیریت مخاطبین ---
        let contacts = JSON.parse(localStorage.getItem('contacts') || '[]');

        function renderContacts() {
            const tbody = $('#contacts-table tbody');
            tbody.empty();
            contacts.forEach((c, i) => {
                tbody.append(`
                    <tr>
                        <td><input type="checkbox" class="contact-checkbox" data-index="${i}" data-name="${c.name}" data-mobile="${c.mobile}" aria-label="انتخاب مخاطب ${c.name}" /></td>
                        <td>${i + 1}</td>
                        <td>${c.name}</td>
                        <td>${c.mobile}</td>
                        <td><button class="btn btn-danger btn-sm delete-contact" data-index="${i}" aria-label="حذف مخاطب"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `);
            });
            localStorage.setItem('contacts', JSON.stringify(contacts));
        }

        $('#add-contact').on('click', () => {
            const name = $('#contact-name').val().trim();
            const mobile = $('#contact-mobile').val().trim();
            if (name && mobile) {
                if (!contacts.some(c => c.name === name && c.mobile === mobile)) {
                    contacts.push({ name, mobile });
                    renderContacts();
                    $('#contact-name, #contact-mobile').val('');
                    Toastify({
                        text: i18next.t('add_contact') + " با موفقیت انجام شد.",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "#22c55e"
                    }).showToast();
                } else {
                    Toastify({
                        text: "این مخاطب قبلاً اضافه شده است.",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "#ef4444"
                    }).showToast();
                }
            } else {
                Toastify({
                    text: i18next.t('attendee_name') + " و " + i18next.t('attendee_mobile') + " را وارد کنید.",
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#ef4444"
                }).showToast();
            }
        });

        $('#contacts-table').on('click', '.delete-contact', function() {
            const idx = $(this).data('index');
            contacts.splice(idx, 1);
            renderContacts();
        });

        $('#select-all-contacts').on('change', function() {
            $('.contact-checkbox').prop('checked', $(this).prop('checked'));
        });

        $('#contacts-search').on('input', function() {
            const val = $(this).val().toLowerCase();
            $('#contacts-table tbody tr').each(function() {
                const name = $(this).find('td:nth-child(3)').text().toLowerCase();
                const mobile = $(this).find('td:nth-child(4)').text().toLowerCase();
                if (name.includes(val) || mobile.includes(val)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        $('#add-selected-attendees').on('click', () => {
            $('.contact-checkbox:checked').each(function() {
                const name = $(this).data('name');
                const mobile = $(this).data('mobile');
                if (!attendees.some(a => a.name === name && a.mobile === mobile)) {
                    attendees.push({ name, mobile });
                }
            });
            renderAttendees();
            Toastify({
                text: i18next.t('add_selected_attendees') + " با موفقیت انجام شد.",
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#22c55e"
            }).showToast();
        });

        // --- 8. وارد کردن مخاطبین با Contacts API ---
        $('#import-contacts').on('click', async () => {
            if ('contacts' in navigator && 'ContactsManager' in window) {
                try {
                    const permission = await navigator.permissions.query({ name: 'contacts' });
                    if (permission.state !== 'granted') {
                        Toastify({
                            text: i18next.t('contacts_permission'),
                            duration: 3000,
                            gravity: "top",
                            position: "center",
                            backgroundColor: "#ef4444"
                        }).showToast();
                        return;
                    }
                    const props = ['name', 'tel'];
                    const opts = { multiple: true };
                    const selectedContacts = await navigator.contacts.select(props, opts);
                    selectedContacts.forEach(c => {
                        const name = (c.name && c.name[0]) || '';
                        const mobile = (c.tel && c.tel[0]) || '';
                        if (name && mobile && !contacts.some(ct => ct.name === name && ct.mobile === mobile)) {
                            contacts.push({ name, mobile });
                        }
                    });
                    renderContacts();
                    Toastify({
                        text: i18next.t('import_contacts') + " با موفقیت انجام شد.",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "#22c55e"
                    }).showToast();
                } catch (e) {
                    console.error(e);
                    Toastify({
                        text: i18next.t('contacts_error'),
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "#ef4444"
                    }).showToast();
                }
            } else {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const text = event.target.result;
                            const lines = text.split('\n');
                            lines.forEach(line => {
                                const [name, mobile] = line.split(',');
                                if (name && mobile && !contacts.some(ct => ct.name === name && ct.mobile === mobile)) {
                                    contacts.push({ name, mobile });
                                }
                            });
                            renderContacts();
                            Toastify({
                                text: i18next.t('import_contacts') + " از فایل CSV انجام شد.",
                                duration: 3000,
                                gravity: "top",
                                position: "center",
                                backgroundColor: "#22c55e"
                            }).showToast();
                        };
                        reader.readAsText(file);
                    }
                };
                input.click();
            }
        });

        // --- 9. افزودن مصوبه ---
        let decisions = [];

        function renderDecisions() {
            const tbody = $('#decisions-table tbody');
            tbody.empty();
            decisions.forEach((d, i) => {
                tbody.append(`
                    <tr>
                        <td>${i + 1}</td>
                        <td>${d.text}</td>
                        <td>${d.responsible}</td>
                        <td>${d.dueDate}</td>
                        <td>${d.status}</td>
                        <td><button class="btn btn-danger btn-sm delete-decision" data-index="${i}" aria-label="حذف مصوبه"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `);
            });
        }

        $('#add-decision').on('click', () => {
            const text = $('#decision-text').val().trim();
            const responsible = $('#decision-responsible').val().trim();
            const dueDate = $('#decision-due-date').val().trim();
            const status = $('#decision-status').val();

            if (text && responsible) {
                decisions.push({ text, responsible, dueDate, status });
                renderDecisions();
                $('#decision-text, #decision-responsible, #decision-due-date').val('');
                $('#decision-status').val('در حال انجام');
            } else {
                Toastify({
                    text: i18next.t('decision_text') + " و " + i18next.t('decision_responsible') + " را وارد کنید.",
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#ef4444"
                }).showToast();
            }
        });

        $('#decisions-table').on('click', '.delete-decision', function() {
            const idx = $(this).data('index');
            decisions.splice(idx, 1);
            renderDecisions();
        });

        // --- 10. اعتبارسنجی فرم ---
        function openSection(id) {
            const header = $(`#section-${id} .form-section-header`);
            const content = $(`#section-${id} .form-section-content`);
            if (!content.hasClass('active')) {
                $('.form-section-content').removeClass('active').attr('aria-hidden', 'true');
                $('.form-section-header').attr('aria-expanded', 'false');
                $('.form-section-header i').removeClass('rotate-down fa-chevron-left').addClass('fa-chevron-right');
                content.addClass('active').attr('aria-hidden', 'false');
                header.attr('aria-expanded', 'true');
                const icon = header.find('i').first();
                icon.addClass('rotate-down fa-chevron-left').removeClass('fa-chevron-right');
            }
        }

        function validateForm() {
            const requiredFields = [
                { id: 'session-number', section: 'session-info', label: i18next.t('session_number') },
                { id: 'session-date', section: 'session-info', label: i18next.t('session_date') },
                { id: 'start-time', section: 'session-info', label: i18next.t('start_time') },
                { id: 'session-title', section: 'session-info', label: i18next.t('session_title') },
                { id: 'location', section: 'session-info', label: i18next.t('location') },
                { id: 'organizer', section: 'session-info', label: i18next.t('organizer') }
            ];
            for (let f of requiredFields) {
                const val = $(`#${f.id}`).val().trim();
                if (!val || (f.id === 'location' && val === '')) {
                    openSection(f.section);
                    $(`#${f.id}`).focus();
                    Toastify({
                        text: i18next.t('fill_required_fields') + ": " + f.label,
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "#ef4444"
                    }).showToast();
                    return false;
                }
            }
            if ($('#location').val() === 'manual' && !$('#location-manual').val().trim()) {
                openSection('session-info');
                $('#location-manual').focus();
                Toastify({
                    text: i18next.t('fill_required_fields') + ": " + i18next.t('location_manual'),
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#ef4444"
                }).showToast();
                return false;
            }
            return true;
        }

        function validateShare() {
            if (!validateForm()) return false;
            if (attendees.length === 0 && decisions.length === 0) {
                Toastify({
                    text: i18next.t('add_attendee_or_decision'),
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#ef4444"
                }).showToast();
                return false;
            }
            return true;
        }

        // --- 11. ذخیره جلسه ---
        let sessions = JSON.parse(localStorage.getItem('sessions') || '[]');

        function getLastSessionNumber() {
            if (sessions.length === 0) return '01';
            const maxNum = Math.max(...sessions.map(s => parseInt(s.number, 10) || 0));
            return String(maxNum + 1).padStart(2, '0');
        }

        $('#session-number').val(getLastSessionNumber());

        $('#save-button').on('click', () => {
            if (!validateForm()) return;

            const number = $('#session-number').val().trim();
            const date = $('#session-date').val().trim();
            const startTime = $('#start-time').val().trim();
            const endTime = $('#end-time').val().trim();
            const title = $('#session-title').val().trim();
            let location = $('#location').val();
            if (location === 'manual') location = $('#location-manual').val().trim();
            const organizer = $('#organizer').val().trim();
            const notes = $('#notes').val().trim();
            const files = $('#session-files')[0].files;

            const existingIndex = sessions.findIndex(s => s.number === number);
            const sessionData = {
                number, date, startTime, endTime, title, location, organizer, notes,
                attendees: [...attendees],
                decisions: [...decisions],
                files: Array.from(files).map(f => f.name)
            };

            if (existingIndex >= 0) {
                sessions[existingIndex] = sessionData;
            } else {
                sessions.push(sessionData);
            }

            localStorage.setItem('sessions', JSON.stringify(sessions));
            Toastify({
                text: i18next.t('session_saved'),
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#22c55e"
            }).showToast();

            $('#session-number').val(getLastSessionNumber());
            attendees = [];
            decisions = [];
            renderAttendees();
            renderDecisions();
            $('#session-date, #start-time, #end-time, #session-title, #location, #location-manual, #organizer, #notes, #session-files').val('');
            $('#location').val('');
        });

        // --- 12. مدیریت آرشیو ---
        function renderArchive() {
            const tbody = $('#archive-table tbody');
            tbody.empty();
            sessions.forEach((s, i) => {
                tbody.append(`
                    <tr>
                        <td>${i + 1}</td>
                        <td>${s.number}</td>
                        <td>${s.title}</td>
                        <td>${s.date}</td>
                        <td>
                            <button class="btn btn-danger btn-sm delete-session" data-index="${i}" aria-label="حذف جلسه"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `);
            });
        }

        $('#archive-search').on('input', function() {
    const val = $(this).val().toLowerCase();
    $('#archive-table tbody tr').each(function() {
        const number = $(this).find('td:nth-child(2)').text().toLowerCase();
        const title = $(this).find('td:nth-child(3)').text().toLowerCase();
        const date = $(this).find('td:nth-child(4)').text().toLowerCase();
        if (number.includes(val) || title.includes(val) || date.includes(val)) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
});

// --- 13. حذف جلسه از آرشیو ---
$('#archive-table').on('click', '.delete-session', function() {
    const idx = $(this).data('index');
    sessions.splice(idx, 1);
    localStorage.setItem('sessions', JSON.stringify(sessions));
    renderArchive();
    Toastify({
        text: "جلسه با موفقیت حذف شد.",
        duration: 3000,
        gravity: "top",
        position: "center",
        backgroundColor: "#ef4444"
    }).showToast();
});

// --- 14. دانلود PDF ---
function generatePDF() {
    if (!validateShare()) return;

    const number = $('#session-number').val().trim();
    const date = $('#session-date').val().trim();
    const startTime = $('#start-time').val().trim();
    const endTime = $('#end-time').val().trim();
    const title = $('#session-title').val().trim();
    let location = $('#location').val();
    if (location === 'manual') location = $('#location-manual').val().trim();
    const organizer = $('#organizer').val().trim();
    const notes = $('#notes').val().trim();

    const element = document.createElement('div');
    element.style.padding = '20px';
    element.style.fontFamily = "'Vazir', sans-serif";
    element.style.direction = 'rtl';
    element.style.textAlign = 'right';
    element.innerHTML = `
        <h2 style="text-align: center; color: #7c3aed;">صورتجلسه شماره ${number}</h2>
        <p><strong>عنوان:</strong> ${title}</p>
        <p><strong>تاریخ:</strong> ${date}</p>
        <p><strong>ساعت شروع:</strong> ${startTime} | <strong>ساعت پایان:</strong> ${endTime || '-'}</p>
        <p><strong>مکان:</strong> ${location}</p>
        <p><strong>برگزارکننده:</strong> ${organizer}</p>
        <h3 style="color: #7c3aed;">شرکت‌کنندگان:</h3>
        <ul>
            ${attendees.map(a => `<li>${a.name} (${a.mobile})</li>`).join('')}
        </ul>
        <h3 style="color: #7c3aed;">مصوبات:</h3>
        <ul>
            ${decisions.map(d => `<li>${d.text} - مسئول: ${d.responsible}, مهلت: ${d.dueDate || '-'}, وضعیت: ${d.status}</li>`).join('')}
        </ul>
        <h3 style="color: #7c3aed;">یادداشت‌ها:</h3>
        <p>${notes || '-'}</p>
    `;

    html2pdf()
        .set({
            margin: 10,
            filename: `session_${number}.pdf`,
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        })
        .from(element)
        .save();
}

$('#print-button').on('click', generatePDF);
$('#download-pdf-btn').on('click', generatePDF);

// --- 15. دانلود Excel ---
$('#export-button').on('click', () => {
    if (!validateShare()) return;

    const number = $('#session-number').val().trim();
    const date = $('#session-date').val().trim();
    const startTime = $('#start-time').val().trim();
    const endTime = $('#end-time').val().trim();
    const title = $('#session-title').val().trim();
    let location = $('#location').val();
    if (location === 'manual') location = $('#location-manual').val().trim();
    const organizer = $('#organizer').val().trim();
    const notes = $('#notes').val().trim();

    const data = [
        { "کلید": "شماره جلسه", "مقدار": number },
        { "کلید": "عنوان", "مقدار": title },
        { "کلید": "تاریخ", "مقدار": date },
        { "کلید": "ساعت شروع", "مقدار": startTime },
        { "کلید": "ساعت پایان", "مقدار": endTime || '-' },
        { "کلید": "مکان", "مقدار": location },
        { "کلید": "برگزارکننده", "مقدار": organizer },
        { "کلید": "یادداشت‌ها", "مقدار": notes || '-' },
        {},
        { "کلید": "شرکت‌کنندگان", "مقدار": "" },
        ...attendees.map((a, i) => ({
            "کلید": `شرکت‌کننده ${i + 1}`,
            "مقدار": `${a.name} (${a.mobile})`
        })),
        {},
        { "کلید": "مصوبات", "مقدار": "" },
        ...decisions.map((d, i) => ({
            "کلید": `مصوبه ${i + 1}`,
            "مقدار": `${d.text} - مسئول: ${d.responsible}, مهلت: ${d.dueDate || '-'}, وضعیت: ${d.status}`
        }))
    ];

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Session');
    XLSX.write(wb, `session_${number}.xlsx`);
});

// --- 16. ارسال به واتساپ ---
function generateWhatsAppSummary() {
    if (!validateShare()) return;

    const number = $('#session-number').val().trim();
    const date = $('#session-date').val().trim();
    const startTime = $('#start-time').val().trim();
    const endTime = $('#end-time').val().trim();
    const title = $('#session-title').val().trim();
    let location = $('#location').val();
    if (location === 'manual') location = $('#location-manual').val().trim();
    const organizer = $('#organizer').val().trim();
    const notes = $('#notes').val().trim();

    const summary = `
${i18next.t('hello')}
*صورتجلسه شماره ${number}*
*عنوان:* ${title}
*تاریخ:* ${date}
*ساعت:* ${startTime} ${endTime ? `- ${endTime}` : ''}
*مکان:* ${location}
*برگزارکننده:* ${organizer}
*شرکت‌کنندگان:*
${attendees.map(a => `- ${a.name} (${a.mobile})`).join('\n')}
*مصوبات:*
${decisions.map((d, i) => `${i + 1}. ${d.text} (مسئول: ${d.responsible}, مهلت: ${d.dueDate || '-'}, وضعیت: ${d.status})`).join('\n')}
*یادداشت‌ها:*
${notes || '-'}
${i18next.t('thanks')}
${i18next.t('company_barakat')}
    `;

    $('#whatsapp-summary-text').val(summary.trim());
    $('#whatsapp-summary-modal').show();
}

$('#whatsapp-button').on('click', generateWhatsAppSummary);

$('#send-whatsapp').on('click', () => {
    const text = $('#whatsapp-summary-text').val().trim();
    if (text) {
        const url = `https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`;
        window.open(url, '_blank');
        $('#whatsapp-summary-modal').hide();
    }
});

$('#close-whatsapp-modal').on('click', () => {
    $('#whatsapp-summary-modal').hide();
});

// --- 17. افزودن به تقویم ---
function addToCalendar() {
    if (!validateForm()) return;

    const title = $('#session-title').val().trim();
    const date = $('#session-date').val().trim();
    const startTime = $('#start-time').val().trim();
    const endTime = $('#end-time').val().trim();
    let location = $('#location').val();
    if (location === 'manual') location = $('#location-manual').val().trim();

    // تبدیل تاریخ شمسی به میلادی
    const persianDateParts = date.split('/');
    const persianDateObj = new persianDate([parseInt(persianDateParts[0]), parseInt(persianDateParts[1]), parseInt(persianDateParts[2])]);
    const gregorianDate = persianDateObj.toLocale('en').format('YYYYMMDD');
    const startDateTime = `${gregorianDate}T${startTime.replace(':', '')}00`;
    const endDateTime = endTime ? `${gregorianDate}T${endTime.replace(':', '')}00` : startDateTime;

    // ایجاد فایل ICS
    const icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'BEGIN:VEVENT',
        `SUMMARY:${title}`,
        `DTSTART:${startDateTime}`,
        `DTEND:${endDateTime}`,
        `LOCATION:${location}`,
        `DESCRIPTION:جلسه برگزار شده توسط ${$('#organizer').val().trim()}`,
        'END:VEVENT',
        'END:VCALENDAR'
    ].join('\n');

    const blob = new Blob([icsContent], { type: 'text/calendar' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `session_${$('#session-number').val().trim()}.ics`;
    a.click();
    window.URL.revokeObjectURL(url);

    Toastify({
        text: i18next.t('calendar_added'),
        duration: 3000,
        gravity: "top",
        position: "center",
        backgroundColor: "#22c55e"
    }).showToast();
}

$('#calendar-button').on('click', addToCalendar);

// --- 18. اشتراک‌گذاری جلسه ---
$('#share-button').on('click', async () => {
    if (!validateShare()) return;

    const number = $('#session-number').val().trim();
    const title = $('#session-title').val().trim();
    const date = $('#session-date').val().trim();
    const startTime = $('#start-time').val().trim();
    const location = $('#location').val() === 'manual' ? $('#location-manual').val().trim() : $('#location').val();

    const shareData = {
        title: `صورتجلسه شماره ${number}`,
        text: `جلسه: ${title}\nتاریخ: ${date}\nساعت: ${startTime}\nمکان: ${location}`,
        url: window.location.href
    };

    if (navigator.share && navigator.canShare(shareData)) {
        try {
            await navigator.share(shareData);
        } catch (err) {
            console.error('Error sharing:', err);
            Toastify({
                text: i18next.t('share_error'),
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#ef4444"
            }).showToast();
        }
    } else {
        // فال‌بک برای مرورگرهایی که Web Share API را پشتیبانی نمی‌کنند
        const text = `${shareData.title}\n${shareData.text}\nلینک: ${shareData.url}`;
        navigator.clipboard.writeText(text).then(() => {
            Toastify({
                text: "لینک جلسه در کلیپ‌بورد کپی شد.",
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "#22c55e"
            }).showToast();
        });
    }
});

// --- 19. مدیریت تم ---
$('#theme').on('change', function() {
    const theme = $(this).val();
    $('body').attr('data-theme', theme);
    localStorage.setItem('theme', theme);
});

// بارگذاری تم ذخیره‌شده
const savedTheme = localStorage.getItem('theme') || 'light';
$('#theme').val(savedTheme);
$('body').attr('data-theme', savedTheme);

// --- 20. باز کردن منو در موبایل ---
$('#menu-toggle').on('click', () => {
    $('.sidebar').slideToggle();
});

// --- 21. رفع مشکل تاریخ ---
function fixDateIssue() {
    $('.pdp').each(function() {
        const val = $(this).val();
        if (val && !/^\d{4}\/\d{2}\/\d{2}$/.test(val)) {
            $(this).val('');
            console.warn('Invalid Persian date format detected and cleared:', val);
        }
    });
}
fixDateIssue();

// --- 22. رندر اولیه ---
renderContacts();
renderArchive();

});
</script>
</body>
</html>
